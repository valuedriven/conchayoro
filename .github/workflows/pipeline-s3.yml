name: pipeline s3

on:
  push:
    branches: [main]

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}  
  ANSIBLE_PLAYBOOK_PATH: .infra

jobs:
  create-file:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get install pandoc
      - run: pandoc README.md -f markdown -t html -s -o index.html
      - uses: actions/upload-artifact@v4
        with:
          name: site
          path: |
            index.html
            .infra/playbook-s3.yml

  setup-environment:
    runs-on: ubuntu-latest
    needs: create-file
    steps:
      # - uses: actions/setup-python@v4
      #   with:
      #     python-version: '3.x'
      # - name: setup Python virtualenv and install packages
      #   run: |
      #     python3 -m venv py3
      #     source py3/bin/activate
      #     python -m pip install --upgrade pip
      #     pip install boto3 botocore ansible==2.10
      #     echo "ANSIBLE_PYTHON_INTERPRETER=$VIRTUAL_ENV/bin/python3" >> $GITHUB_ENV
      #     echo "ENVIRONMENT_SETUP=true" >> $GITHUB_ENV
      #     echo "ANSIBLE_PRIVATE_KEY_FILE=$ANSIBLE_PLAYBOOK_PATH/$PRIVATE_KEY" >> $GITHUB_ENV
      - uses: actions/download-artifact@v4
        with:
          name: site
          path: .
      # - name: provisioning
        # run: |
        #   source py3/bin/activate
        #   ansible-playbook $ANSIBLE_PLAYBOOK_PATH/playbook-s3.yml
      - name: provisioning
        run: ansible-playbook $ANSIBLE_PLAYBOOK_PATH/playbook-s3.yml
